<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.takoyakki.backend.domain.mentoring.repository.MentoringMapper">

    <!-- 멘토링 완료 처리 -->
    <update id="completeMentoring" parameterType="com.takoyakki.backend.domain.mentoring.dto.mentoring.MentoringCompleteRequestDto">
        UPDATE mentoring
        SET
            mentor_name = #{mentorName},
            mentor_image_url = #{mentorImageUrl},
            reserved_date = #{reservedDate},
            reserved_time = #{reservedTime},
            status = 'COMPLETED'
        WHERE reservation_id = #{reservationId}
    </update>

    <!-- 멘토링 상태 수동 변경 -->
    <update id="updateMentoringStatus">
        UPDATE mentoring
        SET status = #{status}
        WHERE reservation_id = #{reservationId}
    </update>

    <!-- 오픈채팅 URL 조회 -->
    <select id="selectOpenChatUrlByReservationId" resultType="string">
        SELECT open_chat_url
        FROM mentoring
        WHERE reservation_id = #{reservationId}
    </select>

    <!-- 멘토 상세조회 (멘토 수락 시 조회하는 DTO) -->
    <select id="findById" resultType="com.takoyakki.backend.domain.mentoring.dto.reservation.MentoringReservationAcceptResponseDto">
        SELECT
            r.id AS reservationId,
            r.mentee_id,
            m.mentor_id,
            m.mentor_name,
            m.mentor_image_url,
            m.open_chat_url,
            r.scheduled_at,
            r.status
        FROM mentoring m
                 JOIN reservation r ON m.reservation_id = r.id
        WHERE m.mentor_id = #{mentorId}
    </select>

    <!-- 멘토링 단건 조회 -->
    <select id="selectMentoringResponseById" resultType="com.takoyakki.backend.domain.mentoring.dto.mentoring.MentoringResponseDto">
        SELECT
            m.id AS mentoringId,
            m.mentor_name,
            m.open_chat_url,
            r.scheduled_at,
            m.mentor_image_url,
            m.status
        FROM mentoring m
                 JOIN reservation r ON m.reservation_id = r.id
        WHERE m.id = #{id}
    </select>

    <!-- 멘토 기준 완료된 멘토링 목록 -->
    <select id="selectCompletedMentoringsByMentorId" resultType="com.takoyakki.backend.domain.mentoring.dto.mentoring.MentoringResponseDto">
        SELECT
            m.id AS mentoringId,
            m.mentor_name,
            m.open_chat_url,
            r.scheduled_at,
            m.mentor_image_url,
            m.status
        FROM mentoring m
                 JOIN reservation r ON m.reservation_id = r.id
        WHERE m.mentor_id = #{mentorId}
          AND m.status = 'COMPLETED'
        ORDER BY r.scheduled_at DESC
    </select>

    <!-- 멘티 기준 완료된 멘토링 목록 -->
    <select id="selectCompletedMentoringsByMenteeId" resultType="com.takoyakki.backend.domain.mentoring.dto.mentoring.MentoringResponseDto">
        SELECT
            m.id AS mentoringId,
            m.mentor_name,
            m.open_chat_url,
            r.scheduled_at,
            m.mentor_image_url,
            m.status
        FROM mentoring m
                 JOIN reservation r ON m.reservation_id = r.id
        WHERE r.mentee_id = #{menteeId}
          AND m.status = 'COMPLETED'
        ORDER BY r.scheduled_at DESC
    </select>

</mapper>
