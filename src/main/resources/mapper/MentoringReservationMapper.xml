<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.takoyakki.backend.domain.mentoring.repository.MentoringReservationMapper">

    <!-- 예약 생성 -->
    <insert id="insertReservation" parameterType="com.takoyakki.backend.domain.mentoring.dto.reservation.MenteeReservationRequestDto">
        INSERT INTO reservation (
            mentor_id,
            mentee_id,
            scheduled_at,
            topic,
            status
        )
        VALUES (
                   #{mentorId},
                   #{menteeId},
                   #{scheduledAt},
                   #{topic},
                   'REQUESTED'
               )
    </insert>

    <!-- 멘토 기준 예약 목록 조회 -->
    <select id="selectReservationsByMentorId" parameterType="long"
            resultType="com.takoyakki.backend.domain.mentoring.dto.reservation.MentoringReservationResponseDto">
        SELECT
            r.id AS reservation_id,
            r.mentee_id,
            r.scheduled_at,
            r.topic,
            r.status,
            u.name AS mentee_name,
            u.profile_image_url AS mentee_image_url
        FROM reservation r
                 JOIN users u ON r.mentee_id = u.id
        WHERE r.mentor_id = #{mentorId}
        ORDER BY r.scheduled_at DESC
    </select>

    <!-- 멘티 기준 예약 목록 조회 -->
    <select id="selectReservationsByMenteeId" parameterType="long"
            resultType="com.takoyakki.backend.domain.mentoring.dto.reservation.MentoringReservationResponseDto">
        SELECT
            r.id AS reservation_id,
            r.mentor_id,
            r.scheduled_at,
            r.topic,
            r.status,
            u.name AS mentor_name,
            u.profile_image_url AS mentor_image_url
        FROM reservation r
                 JOIN users u ON r.mentor_id = u.id
        WHERE r.mentee_id = #{menteeId}
        ORDER BY r.scheduled_at DESC
    </select>

    <!-- 예약 수락 -->
    <update id="acceptReservation" parameterType="long">
        UPDATE reservation
        SET status = 'ACCEPTED'
        WHERE id = #{reservationId}
    </update>

    <!-- 예약 거절 -->
    <update id="rejectReservation">
        UPDATE reservation
        SET status = 'REJECTED'
        WHERE id = #{reservationId}
    </update>

    <!-- 예약 취소 -->
    <update id="cancelReservation">
        UPDATE reservation
        SET status = 'CANCELED'
        WHERE id = #{reservationId}
    </update>

    <!-- 예약 상태 수동 변경 (optional) -->
    <update id="updateReservationStatus">
        UPDATE reservation
        SET status = #{status}
        WHERE id = #{reservationId}
    </update>

</mapper>
